<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: databaseConnector.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: databaseConnector.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file databaseConnector - Create the connexion to the sql database and provide the accessors
 * @author dhmmasson &lt;@dhmmasson>
 * @module Connector
 */

const mysql = require( "mysql2" ) ;

/**
* @class Criteria
* @property {string} name - Unique name of the criteria, to use to reference the criteria
* @property {string} description - Full name to be used to be displayed
* @property {Score} min - Minimum value for the criteria in the database
* @property {Score} max - Maximum value for the criteria in the database
*/
function Criteria( { name, description, min, max } ) {
  this.name = name ;
  this.description = description ;
  this.min = +min ;
  this.max = +max ;
}

/** @typedef {number} Score - number between 0 - 5 */

/**
* @class Evaluation
* @property {string} technology - Name of the technology
* @property {string} criteria -  name of the criteria
* @property {Score} value - evaluation for the couple `technology` - `criteria`
*/

/**
* @class Technology
* @property {string} name - Unique name of the technology, to use to reference the criteria
* @property {string} description - Full name to be used to be displayed
* @property {Object.&lt;Criteria~name,Evaluation~value>} evaluations - Minimum value for the criteria in the database
*/
function Technology( { name, decription } ) {
  this.name = name ;
  this.description = decription ;
  this.evaluations = {} ;
}

/**
 * @class
 * @param  {Express.Application} app the express application to plug into
 */
function Connector( app ) {
  const configuration =
    { host     : process.env.mysqlHost
    , user     : process.env.mysqlUser
    , password : process.env.mysqlPassword
    , database : process.env.mysqlDatabase
    } ;
  // Internal pool to connect to the database
  const pool = mysql.createPool( configuration ).promise() ;
  // register the connector to the application
  app.set( "connector", this ) ;

  /**
  * Connector#getCriteria -  return all the criteria in the database
  *
  * @return {Promise&lt;Criteria[]>}  Promise to deliver the criteria from the database
  */
  this.getCriteria = function() {
    return pool.query(
      `SELECT criteria.name, min( data.value ) as min,  max( data.value ) as max
  FROM criteria
  LEFT JOIN data on data.criteria_name = criteria.name
  GROUP BY criteria.name` )
      .then( cleanCriteria ) ;
  } ;


  /**
   * Connector:getTechnologies - return all evaluated technologies
   *
   * @return {Promise&lt;Technology[]>}  Promise to deliver the evaluated technologies from the database
   */
  this.getTechnologies = function() {
    return pool.query( "select technology_name as technology, criteria_name as criteria, value from data" )
      .then( pivotEvaluation ) ;
  } ;

  /**
  * Connector~pivotEvaluation - Convert an array of evaluation into an array of evaluated technologies
  *
  * @param  {Evaluation[]} evaluations array of evaluations
  * @return {Promise&lt;Technology[]>} Promise a array of evaluated technologies
  */
  function pivotEvaluation( evaluations ) {

    /** @type Object.&lt;String,Technology> */
    const technologiesMap = {} ;

    /** @type Technology[] */
    const technologiesArray = [] ;
    for( const evaluation of evaluations ) {

      /** @type Technology */
      let technology = technologiesMap[ evaluation.technology ] ;

      // Create technology if not already in the array
      if( technology === undefined ) {
        technology = new Technology( evaluation ) ;
        technologiesMap[ evaluation.technology ] = technology ;
        technologiesArray.push( technology ) ;
      }
      technology.evaluations[ evaluation.criteria ] = evaluation.value ;
    }
    return Promise.resolve( technologiesArray ) ;
  }


  /**
   * cleanCriteria - Clean criteria from the database request ( mainly clean the min and max values to be integer)
   *
   * @param  {Array.&lt;Criteria>} rows an array where the first element is an array of criteria to clean
   * @return {Promise.&lt;Criteria[]>}          Cleaned Criteria
   */
  function cleanCriteria( [ rows ] ) {

    /** @type Criteria[] */
    const criterias = [] ;
    for( const row of rows ) {
      criterias.push( new Criteria( row ) ) ;
    }
    return Promise.resolve( criterias ) ;
  }
}

module.exports = function( app ) { return new Connector( app ) ; } ;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-configPugLocals.html">configPugLocals</a></li><li><a href="module-Connector.html">Connector</a></li><li><a href="module-express-autoroute.html">express-autoroute</a></li></ul><h3>Classes</h3><ul><li><a href="module-Connector-Connector.html">Connector</a></li><li><a href="module-Connector-Criteria.html">Criteria</a></li><li><a href="module-Connector-Evaluation.html">Evaluation</a></li><li><a href="module-Connector-Technology.html">Technology</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Tue Feb 11 2020 19:39:17 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
