<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/expressUtils/databaseConnector.mjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/expressUtils/databaseConnector.mjs</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file databaseConnector - Create the connexion to the sql database and provide the accessors
 * @author dhmmasson &lt;@dhmmasson>
 */

import * as models from "../../public/javascripts/Models/index.mjs" ;
import mysql from "mysql2" ;


/**
 * @class
 * @memberof! module:ExpressUtils
 */
function Connector() {
  const configuration =
    { host     : process.env.mysqlHost
    , user     : process.env.mysqlUser
    , password : process.env.mysqlPassword
    , database : process.env.mysqlDatabase
    } ;
  // Internal pool to connect to the database
  const pool = mysql.createPool( configuration ).promise() ;


  /**
  * Connector#getCriterion -  return all the criteria in the database
  *
  * @return {Promise&lt;module:models.Criterion[]>}  Promise to deliver the criteria from the database
  */
  this.getCriteria = function() {
    return pool.query(
      `SELECT criteria.name, min( data.value ) as min, max( data.value ) as max
  FROM criteria
  LEFT JOIN data on data.criteria_name = criteria.name
  GROUP BY criteria.name` )
      .then( cleanCriterion ) ;
  } ;


  /**
   * Connector:getTechnologies - return all evaluated technologies
   *
   * @return {Promise&lt;module:models.Technology[]>}  Promise to deliver the evaluated technologies from the database
   * @todo join with technology table to gather the description
   */
  this.getTechnologies = function() {
    // TODO: join with technology table to gather the description
    return pool.query( "select technology_name as technology, criteria_name as criteria, value from data" )
      .then( pivotEvaluation ) ;
  } ;

  /**
  * Connector~pivotEvaluation - Convert an array of evaluation into an array of evaluated technologies
  *
  * @param  {module:models.Evaluation[]} evaluations array of evaluations
  * @return {Promise&lt;module:models.Technology[]>} Promise a array of evaluated technologies
  */
  function pivotEvaluation( [ evaluations ] ) {

    /** @type Object.&lt;String,Technology> */
    const technologiesMap = {} ;

    /** @type Technology[] */
    const technologiesArray = [] ;
    for( const evaluation of evaluations ) {

      /** @type Technology */
      let technology = technologiesMap[ evaluation.technology ] ;
      // Create technology if not already in the array
      if( technology === undefined ) {
        technology = new models.Technology( evaluation ) ;
        technologiesMap[ evaluation.technology ] = technology ;
        technologiesArray.push( technology ) ;
      }
      technology.evaluations[ evaluation.criteria ] = +evaluation.value ;
    }
    return Promise.resolve( technologiesArray ) ;
  }


  /**
   * cleanCriterion - Clean criteria from the database request ( mainly clean the min and max values to be integer)
   *
   * @param  {Array.&lt;module:models.Criterion>} rows an array where the first element is an array of criteria to clean
   * @return {Promise.&lt;module:models.Criterion[]>}          Cleaned Criterion
   */
  function cleanCriterion( [ rows ] ) {

    /** @type Criterion[] */
    const criterias = [] ;
    for( const row of rows ) {
      criterias.push( new models.Criterion( row ) ) ;
    }
    return Promise.resolve( criterias ) ;
  }
}

export default function() { return new Connector() ; }
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ExpressUtils.html">ExpressUtils</a></li><li><a href="module-HttpUtils.html">HttpUtils</a></li><li><a href="module-Models.html">Models</a></li></ul><h3>Classes</h3><ul><li><a href="EventFirer.html">EventFirer</a></li><li><a href="module-ExpressUtils.Connector.html">Connector</a></li><li><a href="module-Models.Criterion.html">Criterion</a></li><li><a href="module-Models.Evaluation.html">Evaluation</a></li><li><a href="module-Models.Technology.html">Technology</a></li><li><a href="Sorter.html">Sorter</a></li></ul><h3>Global</h3><ul><li><a href="global.html#definePrivateProperties">definePrivateProperties</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Tue Feb 18 2020 23:32:11 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
